<div class="min-vh-100 d-flex flex-column justify-content-center align-items-center py-5 px-3 bg-light">
  <div class="w-100" style="max-width: 480px;">
    <div class="text-center mb-4">
      <div class="text-primary mb-2">
        <i class="bi bi-flask fs-1"></i>
      </div>
      <h2 class="fw-bold mt-2">ClinicaLab</h2>
    </div>

    <div class="card shadow-sm border-light">
      <div class="card-body p-4">
        @if (step === 'request') {
          <div class="text-center mb-4">
            <i class="bi bi-key fs-1 text-primary"></i>
            <h1 class="h5 fw-bold mt-3 mb-2">¿Olvidó su contraseña?</h1>
            <p class="text-muted small">
              Ingrese su correo electrónico para recibir un código de recuperación
            </p>
          </div>

          <form [formGroup]="requestForm" (ngSubmit)="requestRecoveryCode()" class="d-flex flex-column gap-3">
            <div>
              <label class="form-label fw-semibold">Correo electrónico</label>
              <input
                formControlName="email"
                type="email"
                class="form-control"
                [ngClass]="{'is-invalid': email?.invalid && email?.touched}"
                placeholder="ejemplo@correo.com"
              >
              <div class="invalid-feedback" *ngIf="email?.invalid && email?.touched">
                <span *ngIf="email?.errors?.['required']">El email es requerido</span>
                <span *ngIf="email?.errors?.['email']">Email inválido</span>
              </div>
            </div>

            <button 
              type="submit" 
              class="btn btn-primary w-100"
              [disabled]="isLoading"
            >
              <span *ngIf="!isLoading">
                <i class="bi bi-send me-2"></i>
                Solicitar código
              </span>
              <span *ngIf="isLoading">
                <span class="spinner-border spinner-border-sm me-2"></span>
                Generando código...
              </span>
            </button>
          </form>
        }

        @if (step === 'reset') {
          <div class="text-center mb-4">
            <i class="bi bi-shield-lock fs-1 text-success"></i>
            <h1 class="h5 fw-bold mt-3 mb-2">Restablecer contraseña</h1>
            <p class="text-muted small">
              Ingrese el código de 6 dígitos y su nueva contraseña
            </p>
          </div>

          @if (generatedCode) {
            <div class="alert alert-info d-flex align-items-center mb-3">
              <i class="bi bi-info-circle me-2"></i>
              <div class="small">
                <strong>Código generado:</strong> {{ generatedCode }}
                <br>
                <span class="text-muted">Expira en 15 minutos</span>
              </div>
            </div>
          }

          <form [formGroup]="resetForm" (ngSubmit)="resetPassword()" class="d-flex flex-column gap-3">
            <div>
              <label class="form-label fw-semibold">Código de recuperación</label>
              <input
                formControlName="codigo"
                type="text"
                class="form-control text-center fs-5 fw-bold"
                [ngClass]="{'is-invalid': codigo?.invalid && codigo?.touched}"
                placeholder="000000"
                maxlength="6"
              >
              <div class="invalid-feedback" *ngIf="codigo?.invalid && codigo?.touched">
                <span *ngIf="codigo?.errors?.['required']">El código es requerido</span>
                <span *ngIf="codigo?.errors?.['pattern']">Debe ser un código de 6 dígitos</span>
                <span *ngIf="codigo?.errors?.['minlength'] || codigo?.errors?.['maxlength']">
                  Debe tener exactamente 6 dígitos
                </span>
              </div>
            </div>

            <div>
              <label class="form-label fw-semibold">Nueva contraseña</label>
              <input
                formControlName="nuevaPassword"
                type="password"
                class="form-control"
                [ngClass]="{'is-invalid': nuevaPassword?.invalid && nuevaPassword?.touched}"
                placeholder="Mínimo 8 caracteres"
              >
              <div class="invalid-feedback" *ngIf="nuevaPassword?.invalid && nuevaPassword?.touched">
                <span *ngIf="nuevaPassword?.errors?.['required']">La contraseña es requerida</span>
                <span *ngIf="nuevaPassword?.errors?.['minlength']">
                  Debe tener al menos 8 caracteres
                </span>
              </div>
            </div>

            <div>
              <label class="form-label fw-semibold">Confirmar contraseña</label>
              <input
                formControlName="confirmPassword"
                type="password"
                class="form-control"
                [ngClass]="{
                  'is-invalid': (confirmPassword?.invalid && confirmPassword?.touched) || 
                                (confirmPassword?.touched && !passwordsMatch)
                }"
                placeholder="Repita la contraseña"
              >
              <div class="invalid-feedback" *ngIf="confirmPassword?.touched">
                <span *ngIf="confirmPassword?.errors?.['required']">Debe confirmar la contraseña</span>
                <span *ngIf="!passwordsMatch && !confirmPassword?.errors?.['required']">
                  Las contraseñas no coinciden
                </span>
              </div>
            </div>

            <div class="d-grid gap-2">
              <button 
                type="submit" 
                class="btn btn-success"
                [disabled]="isLoading || !passwordsMatch"
              >
                <span *ngIf="!isLoading">
                  <i class="bi bi-check-circle me-2"></i>
                  Restablecer contraseña
                </span>
                <span *ngIf="isLoading">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Actualizando...
                </span>
              </button>

              <button 
                type="button" 
                class="btn btn-outline-secondary"
                (click)="backToRequest()"
                [disabled]="isLoading"
              >
                <i class="bi bi-arrow-left me-2"></i>
                Solicitar nuevo código
              </button>
            </div>
          </form>
        }

        <div class="mt-4 text-center">
          <a routerLink="/auth/login" class="text-muted small text-decoration-none">
            <i class="bi bi-arrow-left me-1"></i>
            Volver a Iniciar Sesión
          </a>
        </div>
      </div>
    </div>

    <div class="mt-3 text-center">
      <small class="text-muted">
        <i class="bi bi-shield-check me-1"></i>
        Sistema académico de recuperación de contraseña
      </small>
    </div>
  </div>
</div>
