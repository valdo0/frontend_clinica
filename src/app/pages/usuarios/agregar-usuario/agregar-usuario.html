<div class="modal fade" [class.show]="isModalOpen" [style.display]="isModalOpen ? 'block' : 'none'" 
     tabindex="-1" aria-labelledby="usuarioModalLabel" [attr.aria-hidden]="!isModalOpen"
     (click)="onBackdropClick($event)">
  <div class="modal-dialog modal-lg" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="usuarioModalLabel">
          {{ modo === 'crear' ? 'Agregar Usuario' : 'Editar Usuario' }}
        </h5>
        <button type="button" class="btn-close" (click)="cerrar()" aria-label="Close"></button>
      </div>

      <form #usuarioForm="ngForm" (ngSubmit)="guardarUsuario(usuarioForm)">
        <div class="modal-body">
          <!-- Mensaje de Error -->
          <div *ngIf="error" class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            {{ error }}
          </div>

          <div class="row g-3">
            <!-- Nombre -->
            <div class="col-12">
              <label for="nombre" class="form-label fw-semibold">
                Nombre Completo <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                id="nombre"
                name="nombre"
                class="form-control"
                required
                [(ngModel)]="nombre"
                placeholder="Ej: Juan Pérez González"
              />
            </div>

            <!-- Email -->
            <div class="col-md-6">
              <label for="email" class="form-label fw-semibold">
                Email <span class="text-danger">*</span>
              </label>
              <input
                type="email"
                id="email"
                name="email"
                class="form-control"
                required
                email
                [(ngModel)]="email"
                placeholder="ejemplo@correo.com"
              />
            </div>

            <!-- Teléfono -->
            <div class="col-md-6">
              <label for="telefono" class="form-label fw-semibold">
                Teléfono <span class="text-danger">*</span>
              </label>
              <input
                type="tel"
                id="telefono"
                name="telefono"
                class="form-control"
                required
                [(ngModel)]="telefono"
                placeholder="+56 9 1234 5678"
              />
            </div>

            <!-- Contraseña -->
            <div class="col-md-6">
              <label for="password" class="form-label fw-semibold">
                Contraseña 
                <span class="text-danger" *ngIf="modo === 'crear'">*</span>
                <small class="text-muted" *ngIf="modo === 'editar'">(Dejar vacío para no cambiar)</small>
              </label>
              <input
                type="password"
                id="password"
                name="password"
                class="form-control"
                [required]="modo === 'crear'"
                minlength="6"
                [(ngModel)]="password"
                placeholder="Mínimo 6 caracteres"
              />
            </div>

            <!-- Rol -->
            <div class="col-md-6">
              <label for="rol" class="form-label fw-semibold">
                Rol <span class="text-danger">*</span>
              </label>
              <select 
                id="rol" 
                name="rol" 
                class="form-select" 
                [(ngModel)]="rol"
                [disabled]="!isAdmin"
              >
                <option value="PACIENTE">Paciente</option>
                <option value="LABMANAGER">Lab Manager</option>
                <option value="ADMIN">Administrador</option>
              </select>
              <small class="text-muted" *ngIf="!isAdmin">
                Solo administradores pueden cambiar roles
              </small>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cerrar()" [disabled]="isLoading">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!usuarioForm.valid || isLoading">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            {{ isLoading ? 'Guardando...' : (modo === 'crear' ? 'Crear Usuario' : 'Guardar Cambios') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal backdrop -->
<div class="modal-backdrop fade" [class.show]="isModalOpen" *ngIf="isModalOpen"></div>
